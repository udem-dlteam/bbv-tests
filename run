#!/bin/sh

SYSTEM=gambit
VIEW=no
TESTS=""

GAMBITDIR="${BBVGAMBITDIR:-../gambit}"

while [ "$#" != "0" ]; do
  case "$1" in
    -g|--gambit) # system
      SYSTEM=gambit
      ;;
    -b|--bigloo) # system
      SYSTEM=bigloo
      ;;
    -c|--clean) # clean
      rm -f tests/*/*.cfg tests/*/*.cfg.pdf tests/*/*.gvm tests/*/*.o* tests/*/*~ tests/*/*.bbv.dot
      exit
      ;;
    -v|--view) # view CFG
      VIEW=yes
      ;;
    -*) # other options
      printf "*** unknown option: $1\n"
      exit 1
      ;;
    *)
      TESTS="$TESTS $1"
      ;;
  esac
  shift
done

run_dot()
{
  if command -v dot > /dev/null 2>&1 ; then
    dot -O -Tpdf $1
  else
    printf "dot program not found!\n"
  fi
}

run_pdfviewer()
{
  if command -v okular > /dev/null 2>&1 ; then
    okular $1
  else
    if command -v open > /dev/null 2>&1 ; then
      open $1
    else
      printf "PDF viewer program not found!\n"
    fi
  fi
}

if test "$TESTS" = "" ; then
  TESTS="tests"
fi

for test in $(find $TESTS -name "*.scm") ; do

  if test "${test#*.gambit.scm}" = "$test" -a "${test#*.bigloo.scm}" = "$test" ; then

    testnoext="${test%.scm}"

    case "$SYSTEM" in

      gambit)
        base="$testnoext.gambit"
        gambitsrc="$base.scm"
        gambitgvm="$base.gvm"
        if test -e "$gambitsrc" ; then
          printf "==================================== $gambitsrc\n"
          $GAMBITDIR/gsi/gsi -:=$GAMBITDIR $GAMBITDIR/gsc/igsc.scm -gvm -cfg $gambitsrc

          run_dot $base.cfg

          CFGPDF=$base.cfg.pdf
          ANALYSISEXT=.gvm

        fi
        ;;

      bigloo)
        base="$testnoext"
        bigloosrc="$base.bgl"
        if test -e "$bigloosrc" ; then
          printf "==================================== $bigloosrc\n"
          bigloo $bigloosrc $base.scm -O3 -saw -fsaw-bbv -fsaw-bbv-fun program -t1 && \
            bglcfg $base-program.bbv.cfg > $base-program.bbv.dot && \
            run_dot $base-program.bbv.dot

          CFGPDF=$base-program.bbv.dot.pdf
          ANALYSISEXT=.cfg

        fi
        ;;

    esac

    if test "$ANALYSISEXT" != "" && fgrep ";; $ANALYSISEXT contains: " $test > /dev/null 2>&1 ; then

      fgrep ";; $ANALYSISEXT contains: " $test | sed -e "s/^;; $ANALYSISEXT contains: //" | while IFS= read -r pattern ; do

        nboccur=$(grep -e "$pattern" $base$ANALYSISEXT | wc -l | sed -e "s/^ *//")

        case "$nboccur" in
          1) printf "SUCCESS -- $base$ANALYSISEXT contains: $pattern\n"
             ;;
          0) printf "FAIL -- pattern not found in $base$ANALYSISEXT: $pattern\n"
             ;;
          *) printf "FAIL -- pattern found $nboccur times in $base$ANALYSISEXT: $pattern\n"
             ;;
        esac

      done

    fi

    if test "$VIEW" = "yes" ; then
      run_pdfviewer $CFGPDF
    fi

  fi

done
